#!/usr/bin/env python                                                                    

import os
import sys
import regis.util
import regis.generation
import regis.build
import regis.test
import regis.git
import regis.rex_json

root = regis.util.find_root()

def __build_regex(files):
  tmp = '"'
  for file in files:
    tmp += '('
    tmp += file
    tmp += ')'
    tmp += '|'

  res = tmp[0:len(tmp) - 1]
  res += '"'
    
  return res

def __gen_cached_changes_regex():
  changes_cache_filepath = os.path.join(regis.util.find_root(), ".git", "file_changed")

  if os.path.exists(changes_cache_filepath):
    cached_changes = regis.rex_json.load_file(changes_cache_filepath)
    local_branch = regis.git.get_local_branchname()
    
    if local_branch in cached_changes:
      files = cached_changes[local_branch]

      return __build_regex(files)   

  return ''

def __generate():
  settings_path = os.path.join(root, "build", "config", "settings.json")

  regex = __gen_cached_changes_regex()

  proc = regis.generation.new_generation(settings_path, f"/performAllChecks(true) /clangTidyRegex({regex})")
  proc.wait()
  return proc.returncode

def __build():
  result = 0
  should_clean = False

  result |= regis.build.new_build("regina", "debug", "msvc", should_clean)
  result |= regis.build.new_build("regina", "debug_opt", "msvc", should_clean)
  result |= regis.build.new_build("regina", "release", "msvc", should_clean)
  result |= regis.build.new_build("regina", "debug", "clang", should_clean)
  result |= regis.build.new_build("regina", "debug_opt", "clang", should_clean)
  result |= regis.build.new_build("regina", "release", "clang", should_clean)
  return result

def __test():
  result = 0

  # not running test here at the moment as they take too long.
  # hopefully we can reduce the time it takes to run our tests
  # then we can enable this again

  return result

def main():
	# we purposely don't run setup here, it's assumed the user has done this before pushing
  # this is to decrease push times

  result = 0

  result = __generate()
  if result != 0:
     print("Generation failed")
     exit(result)

  result = __build()
  if result != 0:
     print("Build failed")
     exit(result)

  result = __test()
  if result != 0:
     print("Tests failed")
     exit(result)

  exit(1)

if __name__ == "__main__":
	main()